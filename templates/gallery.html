<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graph Gallery</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <style>
        .graph-img { max-width: 100%; height: auto; border-radius: 6px; border: 2px solid #eee; margin-bottom: 8px; }
        .graph-card.selected { border: 2px solid #007bff; background: #eaf4ff; }
        .pdf-section { margin-bottom: 2rem; }
    </style>
</head>
<body>
<div class="container py-4">
    <h1 class="mb-4 text-center">Graph Gallery</h1>
    <div class="mb-3 text-center">
        <a href="{{ url_for('index') }}" class="btn btn-link">Upload More PDFs</a>
    </div>
    {% if gallery %}
        <div class="accordion" id="pdfAccordion">
        {% for pdf in gallery %}
            <div class="accordion-item pdf-section">
                <h2 class="accordion-header" id="heading{{ loop.index }}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" aria-expanded="false" aria-controls="collapse{{ loop.index }}">
                        {{ pdf.pdf }}
                    </button>
                </h2>
                <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="heading{{ loop.index }}" data-bs-parent="#pdfAccordion">
                    <div class="accordion-body">
                        {% if pdf.graphs %}
                        <form class="graph-delete-form mb-3" data-pdf-name="{{ pdf.pdf_name }}">
                            <div class="row g-3">
                                {% for graph in pdf.graphs %}
                                <div class="col-md-4 col-12">
                                    <div class="card graph-card h-100 p-2">
                                        <input type="checkbox" class="form-check-input graph-select" name="selected_graphs" value="{{ graph.filename }}" style="margin-bottom: 8px;">
                                        <img src="/static/{{ graph.img }}" class="graph-img" alt="Graph image">
                                        <div class="caption small text-muted">{{ graph.caption }}</div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="mt-3">
                                <button type="button" class="btn btn-danger delete-graphs-btn">Delete Selected Graphs</button>
                            </div>
                        </form>
                        {% else %}
                            <div class="alert alert-info">No graphs found for this PDF.</div>
                        {% endif %}
                        {% if pdf.graphs|length == 0 %}
                        <form class="delete-pdf-form mt-2" data-pdf-name="{{ pdf.pdf_name }}">
                            <button type="button" class="btn btn-outline-danger">Delete PDF</button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-secondary text-center">No PDFs or graphs found. <a href="{{ url_for('index') }}">Upload some PDFs</a>!</div>
    {% endif %}
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
// Handle graph deletion
    document.querySelectorAll('.graph-delete-form').forEach(form => {
        form.querySelector('.delete-graphs-btn').addEventListener('click', function(e) {
            e.preventDefault();
            const pdfName = form.getAttribute('data-pdf-name');
            const selected = Array.from(form.querySelectorAll('.graph-select:checked')).map(cb => cb.value);
            if (selected.length === 0) {
                alert('Select at least one graph to delete.');
                return;
            }
            if (!confirm('Delete selected graphs?')) return;
            fetch('/delete_graphs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ pdf_name: pdfName, graphs: selected })
            }).then(res => res.json()).then(data => {
                if (data.success) location.reload();
            });
        });
    });
    // Handle PDF deletion
    document.querySelectorAll('.delete-pdf-form').forEach(form => {
        form.querySelector('button').addEventListener('click', function(e) {
            e.preventDefault();
            const pdfName = form.getAttribute('data-pdf-name');
            if (!confirm('Delete this PDF and all its data?')) return;
            fetch('/delete_pdf', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ pdf_name: pdfName })
            }).then(res => res.json()).then(data => {
                if (data.success) location.reload();
            });
        });
    });
</script>
</body>
</html> 